name: ğŸ¥ ë¶„ë‹¹ì œì¼ì—¬ì„±ë³‘ì› ë¦¬ë·° ëª¨ë‹ˆí„°ë§

on:
  schedule:
    - cron: '*/5 * * * *'  # 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì‹¤í–‰ (ê°•ì œ ì•Œë¦¼ ë°œì†¡)'
        required: false
        default: 'false'
        type: boolean
      change_threshold:
        description: 'ìµœì†Œ ë³€í™”ëŸ‰ (ê°œ)'
        required: false
        default: '1'
        type: string

jobs:
  monitor-reviews:
    runs-on: ubuntu-latest
    name: ğŸ” ë¦¬ë·° ê°œìˆ˜ ëª¨ë‹ˆí„°ë§
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬
        
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'  # pip ìºì‹œ í™œì„±í™”
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: ğŸ” ë¦¬ë·° ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
      env:
        # ì´ë©”ì¼ ì„¤ì •
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
        GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
        
        # GitHub ì„¤ì •
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
        # ğŸ¯ ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼ ì„¤ì •
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        MIN_CHANGE_THRESHOLD: ${{ github.event.inputs.change_threshold || '1' }}
        QUIET_MODE: 'true'              # ë³€í™”ì—†ìœ¼ë©´ ì¡°ìš©
        NOTIFY_NO_CHANGE: 'false'       # ë¬´ë³€í™” ì•Œë¦¼ ì°¨ë‹¨
        NOTIFY_STARTUP: 'false'         # ì‹œì‘ ì•Œë¦¼ ì°¨ë‹¨
        
      run: |
        echo "ğŸ¯ ëª¨ë‹ˆí„°ë§ ì„¤ì •:"
        echo "- í…ŒìŠ¤íŠ¸ ëª¨ë“œ: $TEST_MODE"
        echo "- ìµœì†Œ ë³€í™”ëŸ‰: $MIN_CHANGE_THRESHOLDê°œ"
        echo "- ì¡°ìš©í•œ ëª¨ë“œ: $QUIET_MODE"
        echo ""
        python monitor_cloud.py
        
    - name: ğŸ“Š ê²°ê³¼ íŒŒì¼ ì»¤ë°‹
      if: always()  # ì‹¤íŒ¨í•´ë„ ê²°ê³¼ ì €ì¥
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì»¤ë°‹
        if [ -n "$(git status --porcelain)" ]; then
          git add review_history.json monitor.log
          git commit -m "ğŸ“Š ë¦¬ë·° ëª¨ë‹ˆí„°ë§ ì—…ë°ì´íŠ¸ - $(date +'%Y-%m-%d %H:%M:%S KST')" || true
          git push || true
          echo "âœ… ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ì €ì¥ ì™„ë£Œ"
        else
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ìŠ¤í‚µ"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“ˆ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "ğŸ‰ ëª¨ë‹ˆí„°ë§ ì‘ì—… ì™„ë£Œ!"
        echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S KST')"
        if [ -f "review_history.json" ]; then
          echo "ğŸ“Š íˆìŠ¤í† ë¦¬ íŒŒì¼ í¬ê¸°: $(wc -l < review_history.json) ì¤„"
        fi
        if [ -f "monitor.log" ]; then
          echo "ğŸ“ ë¡œê·¸ íŒŒì¼ í¬ê¸°: $(wc -l < monitor.log) ì¤„"
          echo ""
          echo "ğŸ” ìµœê·¼ ë¡œê·¸:"
          tail -5 monitor.log || true
        fi
